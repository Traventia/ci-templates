name: 'Build & Deploy (Self-Hosted)'

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to deploy (production or staging)'
        required: false
        type: string
        default: 'production'
      apps:
        description: 'Comma-separated list of apps to build and deploy'
        required: true
        type: string
      eks_namespace:
        description: 'EKS namespace for deployment'
        required: false
        type: string
        default: 'default'
      skip_deploy:
        description: 'Skip deploy step'
        required: false
        type: boolean
        default: false
      skip_push:
        description: 'Skip pushing Docker images to ECR (build only)'
        required: false
        type: boolean
        default: false
      is_bc:
        description: 'BC build/deploy (1 for true, 0 for false)'
        required: false
        type: string
        default: '0'
      build_runner_labels:
        description: 'JSON array of runner labels for the build job'
        required: false
        type: string
        default: '["self-hosted", "ci-runner-build"]'
      persistent_infra_build:
        description: 'Whether build runners have Docker pre-installed'
        required: false
        type: boolean
        default: true
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      AWS_CI_BUCKET_REGION:
        required: true
      AWS_CI_BUCKET:
        required: true
      NPM_AUTH_TOKEN:
        required: false
      EKS_I2_USER_TOKEN:
        required: false
      EKS_I2_CA:
        required: false
      EKS_I2_URL:
        required: false
      EKS_I2_USER_NAME:
        required: false
      RUNNER_WAKE_URL_BUILD:
        required: false
      RUNNER_WAKE_API_KEY_BUILD:
        required: false

jobs:
  wake-build-runners:
    runs-on: ubuntu-latest
    if: ${{ inputs.persistent_infra_build }}
    steps:
      - name: Wake up build runners
        id: wake
        run: |
          if [ -z "${{ secrets.RUNNER_WAKE_URL_BUILD }}" ]; then
            echo "No build wake URL configured, skipping"
            echo "needs_wait=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Waking up build runners..."
          HTTP_STATUS=$(curl -s -o /tmp/wake-response.json -w "%{http_code}" \
            -X POST \
            -H "x-api-key: ${{ secrets.RUNNER_WAKE_API_KEY_BUILD }}" \
            "${{ secrets.RUNNER_WAKE_URL_BUILD }}")

          RESPONSE=$(cat /tmp/wake-response.json)
          echo "Response ($HTTP_STATUS): $RESPONSE"

          if [ "$HTTP_STATUS" -lt 200 ] || [ "$HTTP_STATUS" -gt 299 ]; then
            echo "::error::Wake API returned $HTTP_STATUS - runners may not be available"
            exit 1
          elif echo "$RESPONSE" | grep -q '"started":0'; then
            echo "Runners already active, no wait needed"
            echo "needs_wait=false" >> $GITHUB_OUTPUT
          else
            echo "Runners starting up, will wait for reconnect"
            echo "needs_wait=true" >> $GITHUB_OUTPUT
          fi

      - name: Wait for runners to reconnect
        if: steps.wake.outputs.needs_wait == 'true'
        run: |
          echo "Waiting 45s for runners to resume from hibernate..."
          sleep 45

  build:
    runs-on: ${{ fromJson(inputs.build_runner_labels) }}
    needs: [wake-build-runners]
    if: ${{ !cancelled() && !failure() }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure AWS credentials
        if: ${{ !inputs.persistent_infra_build }}
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_CI_BUCKET_REGION }}

      - name: Set AWS region for instance role
        if: ${{ inputs.persistent_infra_build }}
        shell: bash
        run: |
          echo "AWS_REGION=${{ secrets.AWS_CI_BUCKET_REGION }}" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=${{ secrets.AWS_CI_BUCKET_REGION }}" >> $GITHUB_ENV

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build and push Docker image
        uses: Traventia/ci-templates/.github/actions/build-and-push@main
        with:
          apps: ${{ inputs.apps }}
          ecr_registry: ${{ steps.login-ecr.outputs.registry }}
          image_tag: ${{ github.sha }}
          npm_token: ${{ secrets.NPM_AUTH_TOKEN }}
          is_bc: ${{ inputs.is_bc }}
          skip_push: ${{ inputs.skip_push }}
          aws-access-key-id: ${{ !inputs.persistent_infra_build && secrets.AWS_ACCESS_KEY_ID || '' }}
          aws-secret-access-key: ${{ !inputs.persistent_infra_build && secrets.AWS_SECRET_ACCESS_KEY || '' }}
          aws-region: ${{ secrets.AWS_CI_BUCKET_REGION }}
          s3-bucket: ${{ secrets.AWS_CI_BUCKET }}

  deploy:
    runs-on: ubuntu-latest
    needs: [build]
    if: ${{ !inputs.skip_deploy && !inputs.skip_push && !cancelled() && !failure() }}
    concurrency:
      group: deploy-${{ inputs.apps }}-${{ inputs.environment }}
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Deploy to Kubernetes
        uses: Traventia/ci-templates/.github/actions/deploy-to-k8s@main
        with:
          apps: ${{ inputs.apps }}
          ecr_registry: ${{ steps.login-ecr.outputs.registry }}
          image_tag: ${{ github.sha }}
          k8s_user_token: ${{ secrets.EKS_I2_USER_TOKEN }}
          k8s_ca: ${{ secrets.EKS_I2_CA }}
          k8s_server_url: ${{ secrets.EKS_I2_URL }}
          k8s_user_name: ${{ secrets.EKS_I2_USER_NAME }}
          k8s_namespace: ${{ inputs.eks_namespace }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_CI_BUCKET_REGION }}
          s3-bucket: ${{ secrets.AWS_CI_BUCKET }}
          deploy_env: ${{ inputs.environment }}
          is_bc: ${{ inputs.is_bc }}
          branch: ${{ github.head_ref || github.ref_name }}
