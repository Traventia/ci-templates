name: 'TypeScript Services CI/CD (Matrix + Recheck + Self-Hosted)'

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to deploy (production or staging)'
        required: false
        type: string
        default: 'production'
      apps:
        description: 'Comma-separated list of apps to deploy. If not provided, app identification will be used'
        required: false
        type: string
      eks_namespace:
        description: 'EKS namespace for deployment'
        required: false
        type: string
        default: 'default'
      skip_tests:
        description: 'Skip test execution'
        required: false
        type: boolean
        default: false
      skip_integration_tests:
        description: 'Skip integration test execution'
        required: false
        type: boolean
        default: false
      skip_build:
        description: 'Skip build step'
        required: false
        type: boolean
        default: false
      skip_push:
        description: 'Skip pushing Docker images to ECR (build only)'
        required: false
        type: boolean
        default: false
      skip_deploy:
        description: 'Skip deploy step'
        required: false
        type: boolean
        default: false
      node_version:
        description: 'Node.js version to use'
        required: false
        type: string
        default: '20.x'
      is_bc:
        description: 'Whether this is a BC build/deploy (1 for true, 0 for false)'
        required: false
        type: string
        default: '0'
      runner_labels:
        description: 'JSON array of runner labels for heavy jobs. Use ["self-hosted", "ci-runner"] for self-hosted runners'
        required: false
        type: string
        default: '["ubuntu-latest"]'
      persistent_infra:
        description: 'Whether infrastructure services are pre-installed on the runner (skip docker compose, use health check instead)'
        required: false
        type: boolean
        default: false
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      AWS_CI_BUCKET_REGION:
        required: true
      AWS_CI_BUCKET:
        required: true
      NPM_AUTH_TOKEN:
        required: false
      EKS_I2_USER_TOKEN:
        required: false
      EKS_I2_CA:
        required: false
      EKS_I2_URL:
        required: false
      EKS_I2_USER_NAME:
        required: false
      APOLO_API_TOKEN:
        required: false
      RUNNER_WAKE_URL:
        required: false
      RUNNER_WAKE_API_KEY:
        required: false
    outputs:
      apps_to_deploy:
        description: 'Comma-separated list of applications that will be deployed'
        value: ${{ jobs.check-still-needed.outputs.filtered_apps }}

jobs:
  wake-runners:
    runs-on: ubuntu-latest
    if: ${{ inputs.persistent_infra }}
    steps:
      - name: Wake up self-hosted runners
        run: |
          if [ -z "${{ secrets.RUNNER_WAKE_URL }}" ]; then
            echo "No wake URL configured, skipping"
            exit 0
          fi

          echo "Waking up self-hosted runners..."
          HTTP_STATUS=$(curl -s -o /tmp/wake-response.json -w "%{http_code}" \
            -X POST \
            -H "x-api-key: ${{ secrets.RUNNER_WAKE_API_KEY }}" \
            "${{ secrets.RUNNER_WAKE_URL }}")

          echo "Response ($HTTP_STATUS):"
          cat /tmp/wake-response.json
          echo ""

          if [ "$HTTP_STATUS" -lt 200 ] || [ "$HTTP_STATUS" -gt 299 ]; then
            echo "::warning::Wake API returned $HTTP_STATUS - runners may not be available"
          fi

      - name: Wait for runners to reconnect
        run: |
          echo "Waiting 45s for runners to resume from hibernate and reconnect..."
          sleep 45
          echo "Done"

  identify-apps:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.prepare-matrix.outputs.matrix }}
      apps: ${{ steps.prepare-matrix.outputs.apps }}
    steps:
      - uses: actions/checkout@v3
        if: ${{ !inputs.apps }}
        with:
          fetch-depth: 0

      - name: Identify changed apps
        if: ${{ !inputs.apps }}
        id: identify
        uses: Traventia/ci-templates/.github/actions/identify-changed-apps@main
        with:
          environment: ${{ inputs.environment }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_CI_BUCKET_REGION }}
          s3-bucket: ${{ secrets.AWS_CI_BUCKET }}
          apolo-api-token: ${{ secrets.APOLO_API_TOKEN }}

      - name: Prepare matrix
        id: prepare-matrix
        shell: bash
        run: |
          APPS_CSV="${{ steps.identify.outputs.changed_apps || inputs.apps }}"
          if [ -z "$APPS_CSV" ]; then
            echo "No apps to process"
            echo 'matrix=[]' >> $GITHUB_OUTPUT
            echo 'apps=' >> $GITHUB_OUTPUT
          else
            MATRIX_JSON=$(echo "$APPS_CSV" | jq -R -c 'split(",") | map(select(length > 0))')
            echo "Apps CSV: $APPS_CSV"
            echo "Matrix JSON: $MATRIX_JSON"
            echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
            echo "apps=$APPS_CSV" >> $GITHUB_OUTPUT
          fi

  check-still-needed:
    runs-on: ubuntu-latest
    needs: [identify-apps]
    if: ${{ needs.identify-apps.outputs.matrix != '[]' && needs.identify-apps.outputs.apps != '' }}
    outputs:
      filtered_matrix: ${{ steps.recheck.outputs.filtered_matrix }}
      filtered_apps: ${{ steps.recheck.outputs.filtered_apps }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Re-check which apps still need processing
        id: recheck
        uses: Traventia/ci-templates/.github/actions/check-deploy-needed@main
        with:
          apps: ${{ needs.identify-apps.outputs.apps }}
          environment: ${{ inputs.environment }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_CI_BUCKET_REGION }}
          s3-bucket: ${{ secrets.AWS_CI_BUCKET }}
          apolo-api-token: ${{ secrets.APOLO_API_TOKEN }}

      - name: Log re-check results
        shell: bash
        run: |
          echo "Original apps: ${{ needs.identify-apps.outputs.apps }}"
          echo "Filtered apps: ${{ steps.recheck.outputs.filtered_apps }}"
          echo "Filtered matrix: ${{ steps.recheck.outputs.filtered_matrix }}"
          if [ -z "${{ steps.recheck.outputs.filtered_apps }}" ]; then
            echo "All apps already deployed. Pipeline will skip remaining jobs."
          fi

      - name: Mark apps as PROCESSING
        if: ${{ steps.recheck.outputs.filtered_apps != '' }}
        uses: Traventia/ci-templates/.github/actions/mark-pipeline-status@main
        with:
          apps: ${{ steps.recheck.outputs.filtered_apps }}
          commit-id: ${{ github.sha }}
          environment: ${{ inputs.environment }}
          status: PROCESSING
          apolo-api-token: ${{ secrets.APOLO_API_TOKEN }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_CI_BUCKET_REGION }}
          s3-bucket: ${{ secrets.AWS_CI_BUCKET }}

  unit-tests:
    runs-on: ${{ fromJson(inputs.runner_labels) }}
    needs: [check-still-needed, wake-runners]
    if: ${{ !inputs.skip_tests && !cancelled() && !failure() && needs.check-still-needed.outputs.filtered_matrix != '[]' && needs.check-still-needed.outputs.filtered_matrix != '' }}
    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(needs.check-still-needed.outputs.filtered_matrix) }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Use Node.js ${{ inputs.node_version }}
        if: ${{ !inputs.persistent_infra }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ inputs.node_version }}

      - name: Cache node modules
        if: ${{ !inputs.persistent_infra }}
        id: cache-npm
        uses: actions/cache@v3
        env:
          cache-name: cache-node-modules
        with:
          path: node_modules
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-

      - name: Install dependencies
        if: ${{ !inputs.persistent_infra && steps.cache-npm.outputs.cache-hit != 'true' }}
        run: make install

      - name: Install dependencies (self-hosted)
        if: ${{ inputs.persistent_infra }}
        run: npm install

      - name: Execute unit tests for ${{ matrix.app }}
        env:
          JEST_MAX_WORKERS: ${{ inputs.persistent_infra && '4' || '' }}
        run: make test ${{ matrix.app }}

  integration-tests:
    runs-on: ${{ fromJson(inputs.runner_labels) }}
    needs: [check-still-needed, wake-runners]
    if: ${{ !inputs.skip_integration_tests && !cancelled() && !failure() && needs.check-still-needed.outputs.filtered_matrix != '[]' && needs.check-still-needed.outputs.filtered_matrix != '' }}
    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(needs.check-still-needed.outputs.filtered_matrix) }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Use Node.js ${{ inputs.node_version }}
        if: ${{ !inputs.persistent_infra }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ inputs.node_version }}

      - name: Cache node modules
        if: ${{ !inputs.persistent_infra }}
        id: cache-npm
        uses: actions/cache@v3
        env:
          cache-name: cache-node-modules
        with:
          path: node_modules
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-

      - name: Install dependencies
        if: ${{ !inputs.persistent_infra && steps.cache-npm.outputs.cache-hit != 'true' }}
        run: make install

      - name: Install dependencies (self-hosted)
        if: ${{ inputs.persistent_infra }}
        run: npm install

      - name: Install infrastructure dependencies
        if: ${{ !inputs.persistent_infra }}
        run: make install-infra-deps

      - name: Check infrastructure health
        if: ${{ inputs.persistent_infra }}
        run: make check-infra-health

      - name: Execute integration tests for ${{ matrix.app }}
        env:
          JEST_MAX_WORKERS: ${{ inputs.persistent_infra && '4' || '' }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: make test-i ${{ matrix.app }}

  build:
    runs-on: ${{ fromJson(inputs.runner_labels) }}
    needs: [check-still-needed, wake-runners]
    if: ${{ !inputs.skip_build && !cancelled() && !failure() && needs.check-still-needed.outputs.filtered_matrix != '[]' && needs.check-still-needed.outputs.filtered_matrix != '' }}
    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(needs.check-still-needed.outputs.filtered_matrix) }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build and push Docker image for ${{ matrix.app }}
        uses: Traventia/ci-templates/.github/actions/build-and-push@main
        with:
          apps: ${{ matrix.app }}
          ecr_registry: ${{ steps.login-ecr.outputs.registry }}
          image_tag: ${{ github.sha }}
          npm_token: ${{ secrets.NPM_AUTH_TOKEN }}
          is_bc: ${{ inputs.is_bc }}
          skip_push: ${{ inputs.skip_push }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_CI_BUCKET_REGION }}
          s3-bucket: ${{ secrets.AWS_CI_BUCKET }}

  deploy:
    runs-on: ubuntu-latest
    needs: [check-still-needed, unit-tests, integration-tests, build]
    if: ${{ !inputs.skip_deploy && !inputs.skip_push && !cancelled() && !failure() && needs.check-still-needed.outputs.filtered_matrix != '[]' && needs.check-still-needed.outputs.filtered_matrix != '' }}
    concurrency:
      group: deploy-${{ matrix.app }}-${{ inputs.environment }}
      cancel-in-progress: false
    strategy:
      fail-fast: false
      matrix:
        app: ${{ fromJson(needs.check-still-needed.outputs.filtered_matrix) }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-west-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Deploy ${{ matrix.app }} to Kubernetes
        uses: Traventia/ci-templates/.github/actions/deploy-to-k8s@main
        with:
          apps: ${{ matrix.app }}
          ecr_registry: ${{ steps.login-ecr.outputs.registry }}
          image_tag: ${{ github.sha }}
          k8s_user_token: ${{ secrets.EKS_I2_USER_TOKEN }}
          k8s_ca: ${{ secrets.EKS_I2_CA }}
          k8s_server_url: ${{ secrets.EKS_I2_URL }}
          k8s_user_name: ${{ secrets.EKS_I2_USER_NAME }}
          k8s_namespace: ${{ inputs.eks_namespace }}
          is_bc: ${{ inputs.is_bc }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_CI_BUCKET_REGION }}
          s3-bucket: ${{ secrets.AWS_CI_BUCKET }}
          deploy_env: ${{ inputs.environment }}
          apolo-api-token: ${{ secrets.APOLO_API_TOKEN }}

  finalize-no-deploy:
    runs-on: ubuntu-latest
    needs: [check-still-needed, unit-tests, integration-tests, build]
    if: ${{ (inputs.skip_deploy || inputs.skip_push) && !cancelled() && !failure() && needs.check-still-needed.outputs.filtered_apps != '' }}
    steps:
      - uses: actions/checkout@v3

      - name: Mark pipeline records as SKIPPED
        uses: Traventia/ci-templates/.github/actions/mark-pipeline-status@main
        with:
          apps: ${{ needs.check-still-needed.outputs.filtered_apps }}
          commit-id: ${{ github.sha }}
          environment: ${{ inputs.environment }}
          status: SKIPPED
          apolo-api-token: ${{ secrets.APOLO_API_TOKEN }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_CI_BUCKET_REGION }}
          s3-bucket: ${{ secrets.AWS_CI_BUCKET }}

  cleanup-on-failure:
    runs-on: ubuntu-latest
    needs: [check-still-needed, unit-tests, integration-tests, build, deploy, finalize-no-deploy]
    if: ${{ failure() && needs.check-still-needed.outputs.filtered_apps != '' }}
    steps:
      - uses: actions/checkout@v3

      - name: Mark failed apps as ERROR
        uses: Traventia/ci-templates/.github/actions/mark-pipeline-status@main
        with:
          apps: ${{ needs.check-still-needed.outputs.filtered_apps }}
          commit-id: ${{ github.sha }}
          environment: ${{ inputs.environment }}
          status: ERROR
          apolo-api-token: ${{ secrets.APOLO_API_TOKEN }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_CI_BUCKET_REGION }}
          s3-bucket: ${{ secrets.AWS_CI_BUCKET }}
